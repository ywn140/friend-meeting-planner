<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友见面行程规划</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 加载高德地图API -->
    <script type="text/javascript">  
        window._AMapSecurityConfig = {
            securityJsCode: '1085208f2fd5e87f9b68ddaf5f0855cd'
        }
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=42054149724743aa331367da74475c96"></script>
    <style>
        :root {
            --primary-color: #4a6bff; /* 更现代的蓝色 */
            --secondary-color: #36d39a; /* 清新绿色 */
            --accent-color: #ff9040; /* 温暖橙色 */
            --light-color: #f8fafc; /* 更柔和的浅色背景 */
            --dark-color: #2d3748; /* 深色文字 */
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* 更细腻的阴影 */
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            --transit-color: #9b59b6; /* 公共交通颜色 */
            --walking-color: #36d39a; /* 步行颜色 */
            --driving-color: #4a6bff; /* 驾车颜色 */
            --cycling-color: #ff9040; /* 骑行颜色 */
            --border-radius: 12px; /* 统一的圆角大小 */
            --transition-speed: 0.3s; /* 过渡动画速度 */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: var(--light-color);
            transition: background-color var(--transition-speed) ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-image: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQ0MCIgaGVpZ2h0PSI0MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTAgMGgxNDQwdjE2MGMtMTkuOCA0MC44LTQ4LjkgNzAuMS04Ny41IDg4LTM4LjUgMTcuOC03Ny44IDIzLjItMTE3LjcgMTYtMzkuOC03LjMtODcuNi0yNi42LTE0My4zLTU4LTU1LjctMzEuNC0xMDQuOC00OS0xNDcuMy01Mi44LTQyLjUtMy44LTg2LjctLjktMTMyLjcgOC44LTQ2IDkuNy0xMDQuMyAzMS4yLTE3NSA2NC41LTcwLjcgMzMuMy0xMjIuMiA1NS42LTE1NC41IDY2LjktMzIuMyAxMS4zLTcxLjcgMjEuOC0xMTcuOSAzMS41LTQ2LjMgOS42LTgzLjQgMTUuMy0xMTEuMyAxNy4xLTI4IC44LTYzLjUtLjUtMTA2LjctMy45LTQzLjItMy40LTgxLjYtMTAuNS0xMTUuMi0yMS4yLTMzLjYtMTAuOC02MC40LTIxLjUtODAuNS0zMi4zLTIwLTEwLjgtNDYuMy0yNy43LTc5LTUwLjdWMHoiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iLjA1Ii8+PC9zdmc+');
            background-position: top center;
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 0.2;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .top-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .top-controls > div {
            flex: 1;
            min-width: 300px;
        }
        
        .map-results-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
        }
        
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .card h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 12px;
            margin-bottom: 18px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .card h2 i {
            margin-right: 10px;
            font-size: 1.2em;
            opacity: 0.8;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all var(--transition-speed) ease;
            background-color: #ffffff;
            color: var(--dark-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
        }
        
        input::placeholder {
            color: #a0aec0;
            opacity: 0.8;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }
        
        button:hover {
            background-color: #3350e0; /* 稍深色的变体 */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.5s, opacity 0.8s;
        }
        
        button:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }
        
        button i {
            margin-right: 8px;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
        }
        
        .btn-accent:hover {
            background-color: #e67e22;
        }
        
        .person-card {
            background-color: white;
            padding: 14px 18px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: var(--shadow);
            transition: all var(--transition-speed) ease;
            border-left: 3px solid var(--accent-color);
            overflow: hidden;
        }
        
        .person-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        
        .person-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--accent-color), transparent);
            opacity: 0.2;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        
        .person-card p {
            margin: 5px 0;
        }
        
        .person-card .remove-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background-color: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        
        .map-container {
            height: 400px;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            position: relative;
            transition: all var(--transition-speed) ease;
            border: 4px solid white;
        }
        
        .map-container:hover {
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
            transform: translateY(-3px);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .venue-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .venue-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        
        .venue-card:hover {
            transform: translateY(-5px);
        }
        
        .venue-img {
            width: 100%;
            height: 150px;
            background-color: #eee;
            background-size: cover;
            background-position: center;
        }
        
        .venue-info {
            padding: 15px;
        }
        
        .venue-info h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .venue-info p {
            color: #666;
            margin-bottom: 5px;
        }
        
        .venue-info .venue-type {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        .routes-container {
            margin-top: 24px;
            transition: opacity var(--transition-speed) ease;
        }
        
        .route-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--secondary-color);
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            position: relative;
            overflow: hidden;
        }
        
        .route-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
        }
        
        .route-card.active {
            border-left-color: var(--primary-color);
            transform: scale(1.01);
        }
        
        .route-card h3 {
            color: var(--primary-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        
        .route-card h3 i {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        .route-detail {
            padding-left: 20px;
            border-left: 2px solid rgba(74, 107, 255, 0.2);
            margin-left: 10px;
            position: relative;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .route-step {
            position: relative;
            margin-bottom: 18px;
            border-left: 4px solid #e0e0e0;
            padding: 16px 18px;
            border-radius: 10px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all var(--transition-speed) ease;
        }
        
        .route-step:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateX(3px);
        }
        
        .route-step::before {
            content: '';
            position: absolute;
            left: -9px;
            top: 18px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid #e0e0e0;
            z-index: 1;
        }
        
        .segment-公交 {
            border-left-color: var(--transit-color);
            background-color: rgba(155, 89, 182, 0.08);
        }
        
        .segment-公交::before {
            border-color: var(--transit-color);
            background-color: #fff;
        }
        
        .segment-地铁 {
            border-left-color: var(--transit-color);
            background-color: rgba(155, 89, 182, 0.12);
        }
        
        .segment-地铁::before {
            border-color: var(--transit-color);
            background-color: #fff;
        }
        
        .segment-步行 {
            border-left-color: var(--walking-color);
            background-color: rgba(54, 211, 154, 0.08);
        }
        
        .segment-步行::before {
            border-color: var(--walking-color);
            background-color: #fff;
        }
        
        .segment-驾车 {
            border-left-color: var(--driving-color);
            background-color: rgba(74, 107, 255, 0.08);
        }
        
        .segment-驾车::before {
            border-color: var(--driving-color);
            background-color: #fff;
        }
        
        .segment-骑行 {
            border-left-color: var(--cycling-color);
            background-color: rgba(255, 144, 64, 0.08);
        }
        
        .segment-骑行::before {
            border-color: var(--cycling-color);
            background-color: #fff;
        }
        
        .segment-header {
            display: flex;
            align-items: flex-start;
        }
        
        .segment-icon {
            font-size: 1.3rem;
            margin-right: 12px;
            margin-top: 2px;
            transition: transform var(--transition-speed) ease;
        }
        
        .segment-公交 .segment-icon {
            color: var(--transit-color);
        }
        
        .segment-地铁 .segment-icon {
            color: var(--transit-color);
        }
        
        .segment-步行 .segment-icon {
            color: var(--walking-color);
        }
        
        .segment-驾车 .segment-icon {
            color: var(--driving-color);
        }
        
        .segment-骑行 .segment-icon {
            color: var(--cycling-color);
        }
        
        .route-step:hover .segment-icon {
            transform: scale(1.2);
        }
        
        /* 已移动至新位置 */
        
        .segment-main {
            flex: 1;
        }
        
        .segment-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: white;
            background-color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .segment-公交 .segment-type {
            background-color: #3498db;
        }
        
        .segment-地铁 .segment-type {
            background-color: #9b59b6;
        }
        
        .segment-步行 .segment-type {
            background-color: #2ecc71;
        }
        
        .segment-instruction {
            margin-bottom: 5px;
        }
        
        .segment-time {
            font-size: 0.85rem;
            color: #777;
        }
        
        .segment-detail {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        .station-list {
            list-style: none;
            padding-left: 10px;
            margin: 5px 0;
        }
        
        .station-list li {
            padding: 4px 0;
            font-size: 0.9rem;
        }
        
        .station-list li i {
            margin-right: 5px;
            color: #7f8c8d;
        }
        
        .station-list li i.fa-arrow-alt-circle-up {
            color: #27ae60;
        }
        
        .station-list li i.fa-arrow-alt-circle-down {
            color: #e74c3c;
        }
        
        .route-line-name {
            font-weight: bold;
            color: #3498db;
        }
        
        .segment-地铁 .route-line-name {
            color: #9b59b6;
        }
        
        .walking-instruction {
            font-style: italic;
            color: #555;
            font-size: 0.9rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animated {
            animation-duration: 0.5s;
            animation-fill-mode: both;
        }
        
        .fadeInUp {
            animation-name: fadeInUp;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background-color: transparent;
            color: var(--dark-color);
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-right: 15px;
            transition: all var(--transition-speed) ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
            opacity: 0.9;
            transform: translateY(0);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
            opacity: 1;
        }
        
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background-color: var(--primary-color);
            transition: all 0.3s ease;
            transform: translateX(-50%);
            opacity: 0;
        }
        
        .tab-btn:hover::after {
            width: 100%;
            opacity: 0.5;
        }
        
        .tab-btn.active::after {
            width: 100%;
            opacity: 1;
        }
        
        .tab-content {
            padding: 15px 0;
        }
        
        /* 活动安排样式 */
        .activities-container {
            padding: 10px 0;
        }
        
        .meeting-plan-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            animation: fadeIn 0.5s;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
            margin-bottom: 25px;
        }
        
        .timeline:before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            bottom: 8px;
            width: 3px;
            background: var(--primary-light-color);
            border-radius: 3px;
        }
        
        .time-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .time-item:before {
            content: '';
            position: absolute;
            left: -36px;
            top: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .time {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 15px;
        }
        
        .activity {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
        }
        
        .activity ul {
            margin-top: 8px;
            padding-left: 18px;
        }
        
        .activity li {
            margin-bottom: 5px;
        }
        
        .plan-note {
            background-color: #f8f9fa;
            border-left: 3px solid var(--primary-color);
            padding: 12px 15px;
            font-size: 13px;
            color: #666;
            margin-top: 15px;
            border-radius: 0 4px 4px 0;
        }
        
        /* 周边活动卡片样式 */
        .other-activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .activity-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            transition: all 0.3s ease;
            border-left: 3px solid var(--secondary-color);
        }
        
        .activity-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .activity-card h4 {
            color: var(--primary-color);
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .activity-card p {
            color: var(--text-color);
            font-size: 14px;
            margin: 0;
            line-height: 1.4;
        }
        
        .activity-card i {
            margin-right: 5px;
            color: var(--secondary-color);
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .hidden {
            display: none;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #777;
            font-size: 0.9rem;
        }
    </style>
    <!-- 添加波纹点击效果的JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 为所有按钮添加点击波纹效果
            document.addEventListener('click', function(e) {
                const target = e.target;
                
                // 检查是否点击了按钮或其他可交互元素
                if (target.matches('button') || target.matches('.person-card') || 
                    target.matches('.route-card') || target.matches('.tab-btn')) {
                    
                    // 创建波纹元素
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple-effect');
                    
                    // 获取点击位置相对于元素的坐标
                    const rect = target.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // 设置波纹样式
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    
                    // 添加到目标元素
                    target.appendChild(ripple);
                    
                    // 动画结束后移除波纹元素
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                }
            });
            
            // 为新添加的元素添加动画类
            const animateNewElements = function() {
                // 监视DOM变化
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes.length) {
                            mutation.addedNodes.forEach(function(node) {
                                // 检查是否是元素节点
                                if (node.nodeType === 1) {
                                    // 为新添加的卡片元素添加动画
                                    if (node.classList.contains('route-card') || 
                                        node.classList.contains('person-card')) {
                                        node.classList.add('animated', 'fadeInUp');
                                    }
                                    
                                    // 为路线详情添加动画
                                    const routeDetails = node.querySelectorAll('.route-detail');
                                    routeDetails.forEach(function(detail) {
                                        detail.classList.add('animated', 'fadeInUp');
                                    });
                                }
                            });
                        }
                    });
                });
                
                // 配置观察选项
                const config = { childList: true, subtree: true };
                
                // 开始观察文档
                observer.observe(document.body, config);
            };
            
            // 初始化动画
            animateNewElements();
            
            // 初始化天气功能
            initWeather();
        });
    </script>
    
    <style>
        /* 波纹点击效果 */
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.4);
            width: 10px;
            height: 10px;
            pointer-events: none;
            transform: scale(0);
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            to {
                transform: scale(20);
                opacity: 0;
            }
        }
        
        /* 天气卡片样式 */
        .weather-card {
            margin-bottom: 30px;
        }
        
        .weather-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
            transition: all var(--transition-speed) ease;
        }
        
        .current-weather {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, #4a6bff11, #36d39a11);
            min-height: 120px;
            position: relative;
        }
        
        .weather-icon {
            font-size: 3rem;
            margin-right: 15px;
            color: var(--primary-color);
        }
        
        .weather-info {
            display: flex;
            flex-direction: column;
        }
        
        .temperature {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--dark-color);
            line-height: 1;
        }
        
        .weather-desc {
            font-size: 1.1rem;
            margin-top: 5px;
            color: var(--dark-color);
            opacity: 0.8;
        }
        
        .weather-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .weather-detail-item {
            display: flex;
            align-items: center;
            border-radius: 20px;
            padding: 3px 10px;
            background-color: rgba(255, 255, 255, 0.6);
        }
        
        .weather-detail-item i {
            margin-right: 5px;
            color: var(--primary-color);
        }
        
        .weather-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .weather-loading p {
            margin-top: 10px;
            color: var(--dark-color);
            opacity: 0.7;
        }
        
        .weather-forecast {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 10px 0;
            gap: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
        }
        
        /* 左侧天气卡片特殊样式调整 */
        .left-panel .weather-card {
            margin-bottom: 20px;
        }
        
        .left-panel .forecast-item {
            min-width: 100px;
            padding: 10px;
        }
        
        .left-panel .weather-forecast {
            padding: 5px 0;
        }
        
        .forecast-item {
            min-width: 120px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        
        .forecast-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .forecast-date {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .forecast-icon {
            font-size: 1.8rem;
            margin: 10px 0;
            color: var(--accent-color);
        }
        
        .forecast-temp {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .forecast-desc {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .weather-city {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        .weather-city span {
            margin-right: 10px;
            font-size: 0.9rem;
            color: var(--dark-color);
            opacity: 0.8;
        }
        
        #weather-city-select {
            max-width: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>好友见面行程规划</h1>
            <p>轻松安排与朋友的见面地点和路线</p>
        </header>
        
        <div class="main-content">
            <!-- 顶部控制区 -->
            <div class="top-controls">
                <!-- 天气信息卡片 -->
                <div class="card weather-card">
                    <h2><i class="fas fa-cloud-sun"></i> 天气信息</h2>
                    <div class="weather-container">
                        <div class="current-weather">
                            <div class="weather-loading">
                                <div class="loader"></div>
                                <p>正在获取天气信息...</p>
                            </div>
                        </div>
                        <div class="weather-forecast">
                            <!-- 天气预报将在这里显示 -->
                        </div>
                    </div>
                    <div class="weather-city">
                        <span>当前城市：</span>
                        <select id="weather-city-select">
                            <option value="北京">北京</option>
                            <option value="上海">上海</option>
                            <option value="广州">广州</option>
                            <option value="深圳">深圳</option>
                            <option value="杭州">杭州</option>
                        </select>
                    </div>
                </div>
                
                <!-- 参与人员卡片 -->
                <div class="card">
                    <h2><i class="fas fa-users"></i> 参与人员</h2>
                    <div id="people-list"></div>
                    
                    <div class="form-group">
                        <label for="person-name">姓名</label>
                        <input type="text" id="person-name" placeholder="请输入姓名">
                    </div>
                    
                    <div class="form-group">
                        <label for="person-address">地址</label>
                        <input type="text" id="person-address" placeholder="请输入详细地址">
                    </div>
                    
                    <button id="add-person-btn" class="btn-secondary">
                        <i class="fas fa-plus"></i> 添加人员
                    </button>
                </div>
                
                <!-- 偏好设置卡片 -->
                <div class="card">
                    <h2><i class="fas fa-sliders"></i> 偏好设置</h2>
                    <div class="form-group">
                        <label for="transport-mode">出行方式</label>
                        <select id="transport-mode">
                            <option value="integrated" selected>公共交通(地铁+公交)</option>
                            <option value="walking">步行</option>
                            <option value="driving">驾车</option>
                            <option value="bicycling">骑行</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="venue-type">场所类型</label>
                        <select id="venue-type">
                            <option value="all" selected>全部</option>
                            <option value="mall">购物中心</option>
                            <option value="restaurant">餐厅</option>
                            <option value="cafe">咖啡馆</option>
                        </select>
                    </div>
                    
                    <button id="generate-plan-btn" class="btn-accent">
                        <i class="fas fa-magic"></i> 生成规划
                    </button>
                </div>
            </div>
            
            <!-- 地图和结果区域 -->
            <div class="map-results-area">
                <!-- 加载中显示 -->
                <div id="loading" class="loading hidden">
                    <div class="loading-spinner"></div>
                </div>
                
                <!-- 地图容器 -->
                <div class="card map-card">
                    <h2><i class="fas fa-map-marker-alt"></i> 地图预览</h2>
                    <div class="map-container">
                        <div id="map">
                            <!-- 地图将在这里加载 -->
                        </div>
                    </div>
                </div>
                
                <!-- 结果区域 -->
                <div id="results" class="results-container hidden">
                    <div class="card">
                        <div class="tab-container">
                            <div class="tab-buttons">
                                <button class="tab-btn active" data-tab="venues">推荐场所</button>
                                <button class="tab-btn" data-tab="routes">路线规划</button>
                                <button class="tab-btn" data-tab="activities">活动安排</button>
                            </div>
                            
                            <div class="tab-content">
                                <div id="venues-tab" class="tab-panel active">
                                    <div id="venue-list" class="venue-list">
                                        <!-- 场所卡片将在这里动态加载 -->
                                    </div>
                                </div>
                                
                                <div id="routes-tab" class="tab-panel">
                                    <div id="routes-container" class="routes-container">
                                        <!-- 路线信息将在这里动态加载 -->
                                    </div>
                                </div>
                                
                                <div id="activities-tab" class="tab-panel">
                                    <div id="activities-container" class="activities-container">
                                        <div class="section">
                                            <h2><i class="fas fa-calendar-alt icon"></i>中间位置见面方案</h2>
                                            
                                            <div class="meeting-plan-card">
                                                <h3>推荐活动安排</h3>
                                                <div class="timeline">
                                                    <div class="time-item">
                                                        <div class="time">11:00 - 11:30</div>
                                                        <div class="activity">在推荐场所一层的咖啡厅或休息区集合</div>
                                                    </div>
                                                    <div class="time-item">
                                                        <div class="time">11:30 - 13:00</div>
                                                        <div class="activity">午餐建议(多选一)
                                                            <ul id="lunch-options">
                                                                <li>根据选择的推荐场所自动生成</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <h3>下午活动方案</h3>
                                                <div class="timeline">
                                                    <div class="time-item">
                                                        <div class="time">13:00 - 15:00</div>
                                                        <div class="activity" id="afternoon-activity">根据选择的场所自动生成活动建议</div>
                                                    </div>
                                                    <div class="time-item">
                                                        <div class="time">15:30 - 17:30</div>
                                                        <div class="activity">可自由安排或选择下方「周边推荐」中的其他活动</div>
                                                    </div>
                                                </div>
                                                
                                                <h3>晚餐与夜间活动</h3>
                                                <div class="timeline">
                                                    <div class="time-item">
                                                        <div class="time">18:00 - 20:00</div>
                                                        <div class="activity">晚餐建议(多选一)
                                                            <ul id="evening-options">
                                                                <li>在中间点附近的特色餐厅就餐</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <div class="time-item">
                                                        <div class="time">20:00 - 22:00</div>
                                                        <div class="activity">可选项包括小聚、散步、看电影或参加当地活动</div>
                                                    </div>
                                                </div>
                                                
                                                <div class="plan-note">
                                                    <i class="fas fa-info-circle"></i> 活动安排会根据您选择的会面场所自动调整。以上时间安排仅供参考，可根据实际情况调整。
                                                </div>
                                            </div>
                                            
                                            <div class="meeting-plan-card">
                                                <h3>周边推荐</h3>
                                                <p>除了主要活动安排外，以下是中间位置周边的其他推荐活动：</p>
                                                
                                                <div id="other-activities" class="other-activities-grid">
                                                    <div class="activity-card">
                                                        <h4><i class="fas fa-ticket-alt"></i> 北京国家大剧院</h4>
                                                        <p>地址：北京市西城区西长安街2号</p>
                                                        <p>特色：国家级艺术表演场所，可以欣赏高质量的戏剧和音乐会</p>
                                                    </div>
                                                    
                                                    <div class="activity-card">
                                                        <h4><i class="fas fa-film"></i> 百老汇影城</h4>
                                                        <p>地址：北京市海淀区大钢路6号</p>
                                                        <p>特色：IMAX影院及电影主题餐厅，适合朗望度过</p>
                                                    </div>
                                                    
                                                    <div class="activity-card">
                                                        <h4><i class="fas fa-tree"></i> 北京奥森公园</h4>
                                                        <p>地址：北京市朝阳区机场东路鹏湖南路</p>
                                                        <p>特色：广阔的公园空间，有湖泉和她耐花卉，适合散步活动</p>
                                                    </div>
                                                    
                                                    <div class="activity-card">
                                                        <h4><i class="fas fa-gamepad"></i> 酷玩广场 VR体验馆</h4>
                                                        <p>地址：北京市朝阳区朝阳大悟商城5层</p>
                                                        <p>特色：VR游戏和虚拟现实体验，适合两人以上小组活动</p>
                                                    </div>
                                                    
                                                    <div class="activity-card">
                                                        <h4><i class="fas fa-coffee"></i> 教父咖啡馆</h4>
                                                        <p>地址：北京市东城区罗道胡同青年文创园区</p>
                                                        <p>特色：安静的复古风格咖啡馆，适合小型谈话或休息</p>
                                                    </div>
                                                    
                                                    <div class="activity-card">
                                                        <h4><i class="fas fa-shopping-bag"></i> 三里屯太古里</h4>
                                                        <p>地址：北京市朝阳区工体路太古里19号</p>
                                                        <p>特色：集合各类特色店铺、文创品和美食，比传统胡同行人少</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>好友见面行程规划 &copy; 2025</p>
        </div>
    </div>

    <!-- 脚本部分开始 -->
    
    <script>
        // 全局变量
        const people = [];
        let map = null;
        let markers = [];
        let middlePoint = null;
        let recommendedVenues = [];
        
        // 辅助函数 - 安全获取DOM元素
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`元素 #${id} 不存在`); 
            }
            return element;
        }
        
        // DOM元素
        const peopleList = safeGetElement('people-list');
        const personNameInput = safeGetElement('person-name');
        const personAddressInput = safeGetElement('person-address');
        const addPersonBtn = safeGetElement('add-person-btn');
        const transportModeSelect = safeGetElement('transport-mode');
        const venueTypeSelect = safeGetElement('venue-type');
        const generatePlanBtn = safeGetElement('generate-plan-btn');
        const loadingElement = safeGetElement('loading');
        const resultsElement = safeGetElement('results');
        const venueListElement = safeGetElement('venue-list');
        const routesContainerElement = safeGetElement('routes-container');
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 添加人员按钮点击事件
            addPersonBtn.addEventListener('click', addPerson);
            
            // 生成规划按钮点击事件
            generatePlanBtn.addEventListener('click', generatePlan);
            
            // 标签切换
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });
            
            // 初始化天气功能
            initWeather();
            
            // 添加默认的两个人员示例
            addPersonWithValues('我', '望京宝星园', '116.481270,40.000355');
            addPersonWithValues('朋友', '顺义区绿地启航国际南区', '116.557241,40.114763');
        });
        
        // 添加人员
        function addPerson() {
            const name = personNameInput.value.trim();
            const address = personAddressInput.value.trim();
            
            if (name === '' || address === '') {
                alert('请输入姓名和地址');
                return;
            }
            
            // 调用高德地图API获取地址经纬度
            geocodeAddress(address, function(location) {
                if (location) {
                    addPersonWithValues(name, address, location);
                    
                    // 清空输入框
                    personNameInput.value = '';
                    personAddressInput.value = '';
                } else {
                    alert('无法找到该地址，请尝试更精确的地址');
                }
            });
        }
        
        // 根据提供的值添加人员
        function addPersonWithValues(name, address, location) {
            const person = {
                id: Date.now().toString(),
                name: name,
                address: address,
                location: location
            };
            
            people.push(person);
            renderPeople();
        }
        
        // 渲染人员列表
        function renderPeople() {
            peopleList.innerHTML = '';
            
            people.forEach(person => {
                const personCard = document.createElement('div');
                personCard.className = 'person-card';
                personCard.innerHTML = `
                    <button class="remove-btn" data-id="${person.id}">×</button>
                    <p><strong>${person.name}</strong></p>
                    <p>${person.address}</p>
                `;
                
                peopleList.appendChild(personCard);
                
                // 添加删除按钮事件
                const removeBtn = personCard.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function() {
                    removePerson(person.id);
                });
            });
            
            // 启用或禁用生成按钮
            generatePlanBtn.disabled = people.length < 2;
        }
        
        // 删除人员
        function removePerson(id) {
            const index = people.findIndex(person => person.id === id);
            if (index !== -1) {
                people.splice(index, 1);
                renderPeople();
            }
        }
        
        // 生成规划
        function generatePlan() {
            try {
                if (people.length < 2) {
                    alert('请至少添加两个人员');
                    return;
                }
                
                console.log('开始生成规划...');
                
                // 清空之前的结果
                if (venueListElement) venueListElement.innerHTML = '';
                if (routesContainerElement) routesContainerElement.innerHTML = '';
                
                // 显示加载中
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (resultsElement) resultsElement.classList.add('hidden');
                
                // 计算中间点
                calculateMiddlePoint();
                
                // 初始化地图
                initMap();
                
                // 查找附近场所
                findNearbyVenues();
                
                console.log('规划生成已启动');
            } catch (error) {
                console.error('生成规划时出错:', error);
                alert('生成规划时出错，请检查控制台了解详情。');
                if (loadingElement) loadingElement.classList.add('hidden');
            }
        }
        
        // 验证坐标是否有效
        function validateCoordinates() {
            if (!middlePoint || typeof middlePoint !== 'string') {
                return false;
            }
            
            const parts = middlePoint.split(',');
            if (parts.length !== 2) {
                return false;
            }
            
            const lng = parseFloat(parts[0]);
            const lat = parseFloat(parts[1]);
            
            return !isNaN(lng) && !isNaN(lat);
        }
        
        // 计算中间点
        function calculateMiddlePoint() {
            let totalLng = 0;
            let totalLat = 0;
            let validLocations = 0;
            
            people.forEach(person => {
                try {
                    if (!person.location || typeof person.location !== 'string') {
                        console.error('无效的位置格式:', person.location);
                        return;
                    }
                    
                    const parts = person.location.split(',');
                    if (parts.length !== 2) {
                        console.error('经纬度格式错误:', person.location);
                        return;
                    }
                    
                    const lng = parseFloat(parts[0].trim());
                    const lat = parseFloat(parts[1].trim());
                    
                    if (isNaN(lng) || isNaN(lat)) {
                        console.error('无效的经纬度值:', lng, lat);
                        return;
                    }
                    
                    totalLng += lng;
                    totalLat += lat;
                    validLocations++;
                } catch (error) {
                    console.error('处理位置时出错:', error);
                }
            });
            
            if (validLocations === 0) {
                // 如果没有有效位置，使用默认值（北京市中心）
                middlePoint = '116.397428,39.90923';
                return;
            }
            
            const avgLng = totalLng / validLocations;
            const avgLat = totalLat / validLocations;
            
            middlePoint = `${avgLng.toFixed(6)},${avgLat.toFixed(6)}`;
        }
        
        // 初始化地图
        function initMap() {
            try {
                if (!validateCoordinates()) {
                    // 如果坐标无效，使用北京市中心作为默认位置
                    middlePoint = '116.397428,39.90923';
                }

                const coordinates = middlePoint.split(',');
                const lng = parseFloat(coordinates[0]);
                const lat = parseFloat(coordinates[1]);

                // 初始化地图
                if (!map) {
                    // 创建地图实例
                    map = new AMap.Map('map', {
                        zoom: 12,
                        center: [lng, lat],
                        resizeEnable: true,
                        viewMode: '2D',  // 2D模式更稳定
                        mapStyle: 'amap://styles/normal'
                    });

                    // 添加地图控件
                    map.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
                        map.addControl(new AMap.ToolBar());
                        map.addControl(new AMap.Scale());
                    });
                } else {
                    // 如果地图已经创建，只需要更新中心点
                    map.setCenter([lng, lat]);
                }

                // 清除已有标记
                if (markers.length > 0) {
                    map.remove(markers);
                    markers = [];
                }
                
                // 添加所有人员标记
                people.forEach(person => {
                    try {
                        if (!person.location || typeof person.location !== 'string') {
                            console.error('无效的位置格式:', person.location);
                            return;
                        }

                        const parts = person.location.split(',');
                        if (parts.length !== 2) {
                            console.error('经纬度格式错误:', person.location);
                            return;
                        }

                        const lng = parseFloat(parts[0].trim());
                        const lat = parseFloat(parts[1].trim());

                        if (isNaN(lng) || isNaN(lat)) {
                            console.error('无效的经纬度值:', lng, lat);
                            return;
                        }

                        const position = new AMap.LngLat(lng, lat);
                        const marker = new AMap.Marker({
                            position: position,
                            title: person.name,
                            label: {
                                content: person.name,
                                direction: 'top'
                            }
                        });

                        markers.push(marker);
                    } catch (error) {
                        console.error('创建人员标记时出错:', error);
                    }
                });

                // 添加会面地点标记
                try {
                    const parts = middlePoint.split(',');
                    if (parts.length === 2) {
                        const midLng = parseFloat(parts[0].trim());
                        const midLat = parseFloat(parts[1].trim());

                        if (!isNaN(midLng) && !isNaN(midLat)) {
                            const position = new AMap.LngLat(midLng, midLat);
                            const midMarker = new AMap.Marker({
                                position: position,
                                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png',
                                title: '会面地点'
                            });
                            markers.push(midMarker);
                        }
                    }
                } catch (error) {
                    console.error('创建中间点标记时出错:', error);
                }
                
                // 添加标记并调整视野
                if (markers.length > 0) {
                    try {
                        // 将所有标记添加到地图
                        map.add(markers);
                        
                        // 调整视野以包含所有标记
                        map.setFitView();
                    } catch (error) {
                        console.error('添加标记并调整视野时出错:', error);
                    }
                } else {
                    try {
                        // 如果没有有效标记，设置默认视图
                        map.setCenter(new AMap.LngLat(116.397428, 39.90923)); // 北京市中心
                        map.setZoom(12);
                    } catch (error) {
                        console.error('设置默认地图视图时出错:', error);
                    }
                }
            } catch (error) {
                console.error('初始化地图时出错:', error);
            }
        }
        
        // 搜索附近场所
        async function findNearbyVenues() {
            try {
                console.log('开始查找附近场所...');
                
                if (!venueTypeSelect) {
                    console.error('场所类型选择器不存在');
                    return;
                }
                
                const venueType = venueTypeSelect.value;
                let keywords = '';
                
                // 根据选择的场所类型设置关键词
                switch (venueType) {
                    case 'mall':
                        keywords = '商场';
                        break;
                    case 'restaurant':
                        keywords = '餐厅';
                        break;
                    case 'cafe':
                        keywords = '咖啡馆';
                        break;
                    default:
                        keywords = '商场|餐厅|咖啡馆';
                        break;
                }
                
                if (!middlePoint) {
                    console.error('中间点坐标不存在');
                    if (loadingElement) loadingElement.classList.add('hidden');
                    if (resultsElement) resultsElement.classList.remove('hidden');
                    return;
                }
                
                // 使用AMap.PlaceSearch查找周边兴趣点 - 使用真实数据
                AMap.plugin(['AMap.PlaceSearch', 'AMap.PlaceDetail'], function() {
                    console.log('加载 PlaceSearch 和 PlaceDetail 插件成功');
                    
                    const placeSearch = new AMap.PlaceSearch({
                        pageSize: 10,
                        pageIndex: 1,
                        extensions: 'all'
                    });
                    
                    console.log('中间点坐标:', middlePoint);
                    const [lng, lat] = middlePoint.split(',');
                    
                    console.log('查找关键词:', keywords, '坐标:', [lng, lat]);
                    placeSearch.searchNearBy(keywords, [lng, lat], 3000, async function(status, result) {
                        console.log('PlaceSearch 搜索结果:', status);
                        
                        if (status === 'complete' && result.info === 'OK') {
                            // 获取基本POI数据
                            recommendedVenues = result.poiList.pois;
                            console.log('找到推荐场所:', recommendedVenues.length);
                            
                            // 为每个餐厅获取详细信息，包括更多照片
                            try {
                                const promises = [];
                                
                                for (let i = 0; i < Math.min(recommendedVenues.length, 6); i++) {
                                    const venue = recommendedVenues[i];
                                    // 如果是餐厅或咖啡馆，尝试获取更详细的信息
                                    if (venue.type.includes('餐饮') || venue.type.includes('餐厅') || 
                                        venue.type.includes('咖啡') || venue.name.includes('餐厅') || 
                                        venue.name.includes('咖啡')) {
                                            
                                        const promise = new Promise((resolve) => {
                                            // 创建详情查询实例
                                            const placeDetail = new AMap.PlaceSearch({
                                                extensions: 'all'
                                            });
                                            
                                            // 根据ID查询详细信息
                                            placeDetail.getDetails(venue.id, function(status, detail) {
                                                if (status === 'complete' && detail.info === 'OK') {
                                                    // 将详细信息合并到现有数据中
                                                    const detailPoi = detail.poiList?.pois?.[0];
                                                    if (detailPoi && detailPoi.photos && detailPoi.photos.length > 0) {
                                                        venue.detailPhotos = detailPoi.photos;
                                                        console.log(`场所 ${venue.name} 获取到详细照片:`, venue.detailPhotos);
                                                    }
                                                }
                                                resolve();
                                            });
                                        });
                                        
                                        promises.push(promise);
                                    }
                                }
                                
                                // 等待所有详情请求完成
                                await Promise.all(promises);
                                console.log('所有场所详细信息获取完成');
                            } catch (error) {
                                console.error('获取场所详细信息时出错:', error);
                            }
                            
                            renderVenues();
                            planRoutes();
                        } else {
                            console.error('搜索位置失败', result);
                            // 显示结果面板，即使搜索失败
                            if (loadingElement) loadingElement.classList.add('hidden');
                            if (resultsElement) resultsElement.classList.remove('hidden');
                        }
                    });
                });
            } catch (error) {
                console.error('查找附近场所时出错:', error);
                if (loadingElement) loadingElement.classList.add('hidden');
                if (resultsElement) resultsElement.classList.remove('hidden');
            }
        }
        
        // 渲染推荐场所
        function renderVenues() {
            venueListElement.innerHTML = '';
            
            if (recommendedVenues.length === 0) {
                venueListElement.innerHTML = '<p>未找到符合条件的场所</p>';
                return;
            }
            
            recommendedVenues.forEach((venue, index) => {
                // 只显示前6个场所
                if (index >= 6) return;
                
                // 确定场所类型
                let venueTypeText = '场所';
                let venueIcon = 'fas fa-store';
                
                if (venue.type.includes('购物') || venue.type.includes('商场')) {
                    venueTypeText = '购物中心';
                    venueIcon = 'fas fa-shopping-bag';
                } else if (venue.type.includes('餐饮') || venue.type.includes('餐厅')) {
                    venueTypeText = '餐厅';
                    venueIcon = 'fas fa-utensils';
                } else if (venue.type.includes('咖啡')) {
                    venueTypeText = '咖啡馆';
                    venueIcon = 'fas fa-coffee';
                }
                
                // 检查是否有照片信息
                console.log('场所数据:', venue.id, venue.type, '详细照片:', venue.detailPhotos);
                let photoHtml = '';
                
                // 餐厅真实图片集合 - 用于没有真实照片时的高质量图片
                const restaurantImages = {
                    '西餐': 'https://lbs.amap.com/webapi/public/assets/lbs-web/static/web/restaurant_western.jpg',
                    '中餐': 'https://lbs.amap.com/webapi/public/assets/lbs-web/static/web/restaurant_chinese.jpg',
                    '咖啡馆': 'https://lbs.amap.com/webapi/public/assets/lbs-web/static/web/cafe.jpg',
                    '酒吧': 'https://lbs.amap.com/webapi/public/assets/lbs-web/static/web/bar.jpg',
                    '美食': 'https://lbs.amap.com/webapi/public/assets/lbs-web/static/web/restaurant_general.jpg',
                    '商店': 'https://lbs.amap.com/webapi/public/assets/lbs-web/static/web/shopping.jpg'
                };
                
                // 优先级: 1.详细照片 2.基本照片 3.分类图片 4.图标
                
                // 1. 检查详细照片
                if (venue.detailPhotos && venue.detailPhotos.length > 0) {
                    // 使用详细查询获得的高质量照片
                    const photo = venue.detailPhotos[0];
                    console.log('使用详细高清照片:', photo.url);
                    photoHtml = `<div class="venue-img" style="background-image: url('${photo.url}'); background-size: cover; background-position: center; height: 150px;"></div>`;
                }
                // 2. 检查基本照片
                else if (venue.photos && venue.photos.length > 0) {
                    // 使用POI数据中的基本照片
                    console.log('使用POI基本照片:', venue.photos[0].url);
                    photoHtml = `<div class="venue-img" style="background-image: url('${venue.photos[0].url}'); background-size: cover; background-position: center; height: 150px;"></div>`;
                } 
                // 3. 根据类型用分类图片
                else if (venueTypeText === '餐厅' || venueTypeText === '咖啡馆' || venueTypeText === '购物中心') {
                    // 根据场所类型选择相应图片
                    let imageUrl = '';
                    
                    // 基于餐厅名称或类型的简单判断来选择更符合的图片
                    if (venueTypeText === '购物中心') {
                        imageUrl = restaurantImages['商店'];
                    } else if (venue.name.includes('西') || venue.name.includes('意') || venue.name.includes('Pizza')) {
                        imageUrl = restaurantImages['西餐'];
                    } else if (venue.name.includes('咖啡') || venueTypeText === '咖啡馆') {
                        imageUrl = restaurantImages['咖啡馆'];
                    } else if (venue.name.includes('酒吧') || venue.name.includes('Bar')) {
                        imageUrl = restaurantImages['酒吧'];
                    } else {
                        // 默认使用中餐图片
                        imageUrl = restaurantImages['中餐'];
                    }
                    
                    console.log('使用分类图片:', imageUrl);
                    photoHtml = `<div class="venue-img" style="background-image: url('${imageUrl}'); background-size: cover; background-position: center; height: 150px;"></div>`;
                } 
                // 4. 最后使用图标
                else {
                    // 如果没有照片，使用图标
                    photoHtml = `<div class="venue-img" style="background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; height: 150px;"><i class="${venueIcon}" style="font-size: 2.5rem; color: var(--secondary-color);"></i></div>`;
                }
                
                // 创建场所卡片
                const venueCard = document.createElement('div');
                venueCard.className = 'venue-card';
                venueCard.innerHTML = `
                    ${photoHtml}
                    <div class="venue-info">
                        <span class="venue-type"><i class="${venueIcon}"></i> ${venueTypeText}</span>
                        <h3>${venue.name}</h3>
                        <p><i class="fas fa-map-marker-alt icon"></i> ${venue.address}</p>
                        <p><i class="fas fa-phone icon"></i> ${venue.tel || '暂无电话'}</p>
                        <p><i class="fas fa-road icon"></i> 距中心点${(venue.distance).toFixed(0)}米</p>
                        <button class="btn-secondary select-venue-btn" data-index="${index}">
                            <i class="fas fa-check"></i> 选择此地点
                        </button>
                    </div>
                `;
                
                venueListElement.appendChild(venueCard);
                
                // 添加选择场所按钮事件
                const selectBtn = venueCard.querySelector('.select-venue-btn');
                selectBtn.addEventListener('click', function() {
                    const venueIndex = parseInt(this.getAttribute('data-index'));
                    selectVenue(venueIndex);
                });
            });
        }
        
        // 选择场所
        function selectVenue(index) {
            const selectedVenue = recommendedVenues[index];
            
            // 更新中间点为选择的场所位置
            middlePoint = `${selectedVenue.location.lng},${selectedVenue.location.lat}`;
            
            // 更新地图
            initMap();
            
            // 重新规划路线
            planRoutes();
            
            // 切换到路线规划标签
            activateTab('routes');
        }
        
        // 更新活动安排建议
        function updateActivityPlan(venue) {
            if (!venue) return;
            
            // 获取元素
            const lunchOptionsElement = document.getElementById('lunch-options');
            const afternoonActivityElement = document.getElementById('afternoon-activity');
            const eveningOptionsElement = document.getElementById('evening-options');
            
            if (!lunchOptionsElement || !afternoonActivityElement) return;
            
            // 确定场所类型
            let venueTypeText = '场所';
            
            if (venue.type.includes('购物') || venue.type.includes('商场')) {
                venueTypeText = '购物中心';
                
                // 午餐选项 - 提供更多选择
                lunchOptionsElement.innerHTML = `
                    <li>选择1：${venue.name}内的美食广场或食通区，有多种美食可选</li>
                    <li>选择2：${venue.name}内的特色餐厅，如日料/意式/中式等</li>
                    <li>选择3：${venue.name}附近的人气餐厅街或美食聚集区</li>
                `;
                
                // 下午活动 - 扩展到周边场所
                afternoonActivityElement.innerHTML = `
                    <ul>
                        <li>选择1：在${venue.name}购物中心内购物、预览新款或体验演示活动</li>
                        <li>选择2：前往附近的娱乐设施，如电影院、体验馆或游戏厅</li>
                        <li>选择3：在附近公园或休闲区域放松活动，达到加深交流的目的</li>
                    </ul>
                `;
                
            } else if (venue.type.includes('餐饮') || venue.type.includes('餐厅')) {
                venueTypeText = '餐厅';
                
                // 午餐选项
                lunchOptionsElement.innerHTML = `
                    <li>选择1：在${venue.name}共进午餐，品尝特色菜品</li>
                    <li>选择2：在${venue.name}附近的其他特色餐厅就餐</li>
                    <li>选择3：如果${venue.name}有私人包间，可预订私人空间享用更加安静的用餐环境</li>
                `;
                
                // 下午活动 - 扩展到周边娱乐场所
                afternoonActivityElement.innerHTML = `
                    <ul>
                        <li>选择1：用餐后前往${venue.name}附近的购物中心或商场活动</li>
                        <li>选择2：散步前往附近的公园、湖边小径或文化街区休闲</li>
                        <li>选择3：前往附近的文化场所，如博物馆、美术馆或特色展览</li>
                    </ul>
                `;
                
            } else if (venue.type.includes('咖啡') || venue.name.includes('咖啡')) {
                venueTypeText = '咖啡馆';
                
                // 午餐选项
                lunchOptionsElement.innerHTML = `
                    <li>选择1：在${venue.name}点一些轻食餐点和特色饮品</li>
                    <li>选择2：前往${venue.name}附近的餐厅就餐，午餐后返回品尝咖啡</li>
                    <li>选择3：在附近美食区取餐，带回${venue.name}一起用餐</li>
                `;
                
                // 下午活动
                afternoonActivityElement.innerHTML = `
                    <ul>
                        <li>选择1：在${venue.name}享受轻松的下午茶时光，可以聊天、看书或工作</li>
                        <li>选择2：前往附近的书店、艺术画廊或特色文化商店游览</li>
                        <li>选择3：去附近的公园、广场或黄昏市集感受当地氛围</li>
                    </ul>
                `;
                
            } else {
                // 其他地点
                lunchOptionsElement.innerHTML = `
                    <li>选择1：在${venue.name}附近的人气餐厅就餐</li>
                    <li>选择2：寻找${venue.name}周边的美食街或美食广场</li>
                    <li>选择3：可以提前预订周边特色餐厅，避免等位</li>
                `;
                
                // 下午活动
                afternoonActivityElement.innerHTML = `
                    <ul>
                        <li>选择1：在${venue.name}及周边区域活动，探索附近的有趣地点</li>
                        <li>选择2：前往附近的商场、购物中心或特色商业街区</li>
                        <li>选择3：参加附近的休闲活动，如电影院、体验馆或游戏中心</li>
                    </ul>
                `;
            }
            
            // 新增晚餐选项 - 添加夜间活动的选择
            if (eveningOptionsElement) {
                eveningOptionsElement.innerHTML = `
                    <li>选择1：${venue.name}附近的特色餐厅，可选不同于午餐的风格</li>
                    <li>选择2：附近的餐厅街或夜市，体验当地夜生活</li>
                    <li>选择3：精选的餐厅，预定包间享用私密空间</li>
                `;
            }
            
            // 更新其他广场内容元素 - 可以加入更多的多样化建议
            const otherActivitiesElement = document.getElementById('other-activities');
            if (otherActivitiesElement) {
                otherActivitiesElement.innerHTML = `
                    <div class="activity-card">
                        <h4><i class="fas fa-ticket-alt"></i> 附近文化设施</h4>
                        <p>可以考虑前往附近的电影院、剧院、音乐厅或展览馆</p>
                    </div>
                    <div class="activity-card">
                        <h4><i class="fas fa-tree"></i> 户外活动</h4>
                        <p>周边公园、广场或户外活动区，适合散步或运动</p>
                    </div>
                    <div class="activity-card">
                        <h4><i class="fas fa-gamepad"></i> 互动体验</h4>
                        <p>附近的娱乐中心、桌游运动厅或VR体验中心</p>
                    </div>
                `;
            }
        }
        
        // 规划路线
        function planRoutes() {
            routesContainerElement.innerHTML = '';
            const transportMode = transportModeSelect.value;
            let completedRoutes = 0;
            
            // 检查当前有多少人员需要规划路线
            const totalPeople = people.length;
            
            // 为每个人规划路线
            people.forEach(person => {
                // 创建路线卡片占位符
                const routeCard = document.createElement('div');
                routeCard.className = 'route-card';
                routeCard.innerHTML = `
                    <h3><i class="fas fa-user"></i> ${person.name} 的出行路线</h3>
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>正在规划路线...</p>
                    </div>
                `;
                
                routesContainerElement.appendChild(routeCard);
                
                // 根据选择的交通方式规划路线
                switch (transportMode) {
                    case 'integrated':
                        planTransitRoute(person, routeCard, function() {
                            routeComplete();
                        });
                        break;
                    case 'walking':
                        planWalkingRoute(person, routeCard, function() {
                            routeComplete();
                        });
                        break;
                    case 'driving':
                        planDrivingRoute(person, routeCard, function() {
                            routeComplete();
                        });
                        break;
                    case 'bicycling':
                        planBicyclingRoute(person, routeCard, function() {
                            routeComplete();
                        });
                        break;
                }
            });
            
            function routeComplete() {
                completedRoutes++;
                
                // 当所有路线都规划完成时，隐藏加载中
                if (completedRoutes === totalPeople) {
                    loadingElement.classList.add('hidden');
                    resultsElement.classList.remove('hidden');
                }
            }
        }
        
        // 规划公共交通路线 - 使用真实高德地图API数据
        function planTransitRoute(person, routeCard, callback) {
            try {
                // 使用JS API同步获取公交数据，避免跨域问题
                const startParts = person.location.split(',');
                const endParts = middlePoint.split(',');
                
                if (startParts.length !== 2 || endParts.length !== 2) {
                    renderRouteError(routeCard, '坐标格式错误');
                    callback();
                    return;
                }
                
                const startLng = parseFloat(startParts[0].trim());
                const startLat = parseFloat(startParts[1].trim());
                const endLng = parseFloat(endParts[0].trim());
                const endLat = parseFloat(endParts[1].trim());
                
                if (isNaN(startLng) || isNaN(startLat) || isNaN(endLng) || isNaN(endLat)) {
                    renderRouteError(routeCard, '无效的经纬度值');
                    callback();
                    return;
                }

                // 添加一些日志信息
                console.log('起点:', startLng, startLat);
                console.log('终点:', endLng, endLat);
                
                // 使用AMap.Transfer查询公交路线
                AMap.plugin('AMap.Transfer', function() {
                    const transfer = new AMap.Transfer({
                        city: '北京',  // 指定城市为北京
                        policy: AMap.TransferPolicy.LEAST_TIME,  // 使用最快速度策略
                        nightflag: true,  // 包含夜班车
                        extensions: 'all',  // 返回详细信息
                        key: '42054149724743aa331367da74475c96'  // 路线规划专用key
                    });
                    
                    // 使用AMap.LngLat对象指定起终点
                    const startPos = new AMap.LngLat(startLng, startLat);
                    const endPos = new AMap.LngLat(endLng, endLat);
                    
                    // 搜索公交路线
                    transfer.search(startPos, endPos, function(status, result) {
                        console.log('公交查询状态:', status);
                        console.log('公交查询结果:', result);
                        
                        if (status === 'complete' && result.info === 'OK') {
                            // 处理路线结果
                            renderRouteResult(status, result, routeCard, '公共交通');
                            callback();
                        } else {
                            // 尝试其他公交相关查询方法
                            tryAlternativeTransit();
                        }
                    });
                });
                
                // 尝试其他公交相关查询方法
                function tryAlternativeTransit() {
                    // 使用公交线路查询API
                    AMap.plugin('AMap.LineSearch', function() {
                        const lineSearch = new AMap.LineSearch({
                            pageIndex: 1,
                            city: '北京', 
                            pageSize: 5
                        });
                        
                        // 查询公交线路空间
                        const options = {
                            method: 'get',
                            url: `https://map.amap.com/service/poiInfo?query_type=TQUERY&pagesize=20&pagenum=1&qii=true&cluster_state=5&need_utd=true&utd_sceneid=1000&div=PC1000&addr_poi_merge=true&is_classify=true&zoom=12&city=110000&geoobj=${startLng-0.1},${startLat-0.1},${startLng+0.1},${startLat+0.1}&keywords=公交站`,
                            dataType: 'jsonp',
                            jsonp: 'callback'
                        };
                        
                        // 这里我们使用步行作为备选，因为公交查询失败
                        planWalkingRoute(person, routeCard, function() {
                            // 在路线卡片上显示错误提示
                            const routeInfo = routeCard.querySelector('.route-info');
                            if (routeInfo) {
                                routeInfo.innerHTML += '<p class="warning">提示: 公交路线查询失败，已切换为步行路线</p>';
                            }
                            callback();
                        });
                    });
                }
            } catch (error) {
                console.error('规划公交路线时出错:', error);
                renderRouteError(routeCard, '规划路线时出错');
                callback();
            }
        }
        
        // 规划步行路线
        function planWalkingRoute(person, routeCard, callback) {
            try {
                AMap.plugin('AMap.Walking', function() {
                    const walking = new AMap.Walking({
                        key: '42054149724743aa331367da74475c96'  // 路线规划专用key
                    });
                    
                    // 安全地解析起点和终点坐标
                    const startParts = person.location.split(',');
                    const endParts = middlePoint.split(',');
                    
                    if (startParts.length !== 2 || endParts.length !== 2) {
                        renderRouteError(routeCard, '坐标格式错误');
                        callback();
                        return;
                    }
                    
                    const startLng = parseFloat(startParts[0].trim());
                    const startLat = parseFloat(startParts[1].trim());
                    const endLng = parseFloat(endParts[0].trim());
                    const endLat = parseFloat(endParts[1].trim());
                    
                    if (isNaN(startLng) || isNaN(startLat) || isNaN(endLng) || isNaN(endLat)) {
                        renderRouteError(routeCard, '无效的经纬度值');
                        callback();
                        return;
                    }
                    
                    const startPos = new AMap.LngLat(startLng, startLat);
                    const endPos = new AMap.LngLat(endLng, endLat);
                    
                    walking.search(
                        startPos,
                        endPos,
                        function(status, result) {
                            renderRouteResult(status, result, routeCard, '步行');
                            callback();
                        }
                    );
                });
            } catch (error) {
                console.error('规划步行路线时出错:', error);
                renderRouteError(routeCard, '规划路线时出错');
                callback();
            }
        }
        
        // 规划驾车路线
        function planDrivingRoute(person, routeCard, callback) {
            try {
                AMap.plugin('AMap.Driving', function() {
                    const driving = new AMap.Driving({
                        policy: AMap.DrivingPolicy.LEAST_TIME,
                        key: '42054149724743aa331367da74475c96'  // 路线规划专用key
                    });
                    
                    // 安全地解析起点和终点坐标
                    const startParts = person.location.split(',');
                    const endParts = middlePoint.split(',');
                    
                    if (startParts.length !== 2 || endParts.length !== 2) {
                        renderRouteError(routeCard, '坐标格式错误');
                        callback();
                        return;
                    }
                    
                    const startLng = parseFloat(startParts[0].trim());
                    const startLat = parseFloat(startParts[1].trim());
                    const endLng = parseFloat(endParts[0].trim());
                    const endLat = parseFloat(endParts[1].trim());
                    
                    if (isNaN(startLng) || isNaN(startLat) || isNaN(endLng) || isNaN(endLat)) {
                        renderRouteError(routeCard, '无效的经纬度值');
                        callback();
                        return;
                    }
                    
                    const startPos = new AMap.LngLat(startLng, startLat);
                    const endPos = new AMap.LngLat(endLng, endLat);
                    
                    driving.search(
                        startPos,
                        endPos,
                        function(status, result) {
                            renderRouteResult(status, result, routeCard, '驾车');
                            callback();
                        }
                    );
                });
            } catch (error) {
                console.error('规划驾车路线时出错:', error);
                renderRouteError(routeCard, '规划路线时出错');
                callback();
            }
        }
        
        // 规划骑行路线
        function planBicyclingRoute(person, routeCard, callback) {
            try {
                AMap.plugin('AMap.Riding', function() {
                    const riding = new AMap.Riding({
                        policy: 1,
                        key: '42054149724743aa331367da74475c96'  // 路线规划专用key
                    });
                    
                    // 安全地解析起点和终点坐标
                    const startParts = person.location.split(',');
                    const endParts = middlePoint.split(',');
                    
                    if (startParts.length !== 2 || endParts.length !== 2) {
                        renderRouteError(routeCard, '坐标格式错误');
                        callback();
                        return;
                    }
                    
                    const startLng = parseFloat(startParts[0].trim());
                    const startLat = parseFloat(startParts[1].trim());
                    const endLng = parseFloat(endParts[0].trim());
                    const endLat = parseFloat(endParts[1].trim());
                    
                    if (isNaN(startLng) || isNaN(startLat) || isNaN(endLng) || isNaN(endLat)) {
                        renderRouteError(routeCard, '无效的经纬度值');
                        callback();
                        return;
                    }
                    
                    const startPos = new AMap.LngLat(startLng, startLat);
                    const endPos = new AMap.LngLat(endLng, endLat);
                    
                    riding.search(
                        startPos,
                        endPos,
                        function(status, result) {
                            renderRouteResult(status, result, routeCard, '骑行');
                            callback();
                        }
                    );
                });
            } catch (error) {
                console.error('规划骑行路线时出错:', error);
                renderRouteError(routeCard, '规划路线时出错');
                callback();
            }
        }
        
        // 渲染路线错误信息
        function renderRouteError(routeCard, errorMessage) {
            // 移除加载中显示
            const loadingElement = routeCard.querySelector('.loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            // 创建路线详情元素
            const routeDetail = document.createElement('div');
            routeDetail.className = 'route-detail';
            
            routeDetail.innerHTML = `
                <div class="route-error">
                    <p><i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> 无法规划路线</p>
                    <p>${errorMessage}</p>
                    <p>请尝试其他交通方式或确认地址是否正确。</p>
                </div>
            `;
            
            // 将路线详情添加到路线卡片
            routeCard.appendChild(routeDetail);
        }
        
        // 渲染路线结果
        function renderRouteResult(status, result, routeCard, transportType) {
            // 移除加载中显示
            const loadingElement = routeCard.querySelector('.loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            // 创建路线详情元素
            const routeDetail = document.createElement('div');
            routeDetail.className = 'route-detail';
            
            if (status === 'complete' && result.info === 'OK') {
                let route;
                let steps;
                
                // 根据不同的交通方式获取路线信息
                switch (transportType) {
                    case '公共交通':
                        if (result.plans && result.plans.length > 0) {
                            route = result.plans[0];
                            steps = route.segments;
                            
                            // 添加总体概述
                            routeDetail.innerHTML = `
                                <div class="route-summary">
                                    <p><i class="fas fa-clock icon"></i> 总时间: ${formatDuration(route.time)}</p>
                                    <p><i class="fas fa-road icon"></i> 总距离: ${(route.distance/1000).toFixed(1)}公里</p>
                                    <p><i class="fas fa-coins icon"></i> 花费: ${route.cost}元</p>
                                </div>
                            `;
                            
                            console.log('公共交通路线数据:', route);
                            
                            // 添加各步骤
                            console.log('路线段落数据:', steps);
                            
                            steps.forEach((segment, index) => {
                                const stepElement = document.createElement('div');
                                stepElement.className = 'route-step';
                                
                                // 根据交通方式设置图标和类型
                                let icon = 'fas fa-walking';
                                let segmentType = '步行';
                                let instruction = '';
                                let detail = '';
                                
                                // 适配新的API响应格式，处理segments数组
                                if (segment.transit_mode) {
                                    // 根据交通模式设置图标和类型
                                    if (segment.transit_mode === 'SUBWAY' || segment.transit_mode === 'RAIL') {
                                        icon = 'fas fa-subway';
                                        segmentType = '地铁';
                                    } else if (segment.transit_mode === 'BUS') {
                                        icon = 'fas fa-bus';
                                        segmentType = '公交';
                                    } else if (segment.transit_mode === 'WALK') {
                                        icon = 'fas fa-walking';
                                        segmentType = '步行';
                                    }
                                    
                                    // 使用API返回的instruction
                                    if (segment.instruction) {
                                        instruction = segment.instruction;
                                    }
                                    
                                    // 如果有详细说明，添加到详情中
                                    if (segment.instructions) {
                                        detail = `<p class="segment-instructions">${segment.instructions}</p>`;
                                    }
                                    
                                    // 显示详细时间和距离信息
                                    if (segment.distance !== undefined && segment.time !== undefined) {
                                        const distanceText = segment.distance > 1000 ? 
                                            `${(segment.distance/1000).toFixed(1)}公里` : 
                                            `${segment.distance}米`;
                                        instruction += ` (距离: ${distanceText}, 时间: ${formatDuration(segment.time)})`;
                                    }
                                } else {
                                    // 兼容旧的数据结构
                                    // 判断是否有公交或地铁信息
                                    if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
                                        const busline = segment.bus.buslines[0];
                                        icon = busline.type === 0 ? 'fas fa-bus' : 'fas fa-subway';
                                        segmentType = busline.type === 0 ? '公交' : '地铁';
                                        
                                        // 添加更详细的公交信息
                                        let departureStop = (busline.departure_stop && busline.departure_stop.name) ? busline.departure_stop.name : '起点';
                                        let arrivalStop = (busline.arrival_stop && busline.arrival_stop.name) ? busline.arrival_stop.name : '终点';
                                        let viaStopsCount = 0;
                                        
                                        if (busline.via_stops && Array.isArray(busline.via_stops)) {
                                            viaStopsCount = busline.via_stops.length;
                                            
                                            // 如果有途经站点，显示站点列表
                                            if (viaStopsCount > 0) {
                                                detail = '<ul class="station-list">';
                                                detail += `<li><i class="fas fa-arrow-alt-circle-up"></i> <strong>${departureStop}</strong> (上车)</li>`;
                                                
                                                busline.via_stops.forEach(stop => {
                                                    if (stop && stop.name) {
                                                        detail += `<li><i class="fas fa-circle"></i> ${stop.name}</li>`;
                                                    }
                                                });
                                                
                                                detail += `<li><i class="fas fa-arrow-alt-circle-down"></i> <strong>${arrivalStop}</strong> (下车)</li>`;
                                                detail += '</ul>';
                                            }
                                        }
                                        
                                        instruction = `乘坐 <span class="route-line-name">${busline.name}</span>，从 <strong>${departureStop}</strong> 上车，到 <strong>${arrivalStop}</strong> 下车，共 ${viaStopsCount} 站`;
                                    } else if (segment.railway && segment.railway.name) {
                                        icon = 'fas fa-subway';
                                        segmentType = '地铁';
                                        
                                        // 添加更详细的地铁信息
                                        let departureStop = (segment.railway.departure_stop && segment.railway.departure_stop.name) ? segment.railway.departure_stop.name : '起点';
                                        let arrivalStop = (segment.railway.arrival_stop && segment.railway.arrival_stop.name) ? segment.railway.arrival_stop.name : '终点';
                                        let viaStopsCount = 0;
                                        
                                        if (segment.railway.via_stops && Array.isArray(segment.railway.via_stops)) {
                                            viaStopsCount = segment.railway.via_stops.length;
                                            
                                            // 如果有途经站点，显示站点列表
                                            if (viaStopsCount > 0) {
                                                detail = '<ul class="station-list">';
                                                detail += `<li><i class="fas fa-arrow-alt-circle-up"></i> <strong>${departureStop}</strong> (上车)</li>`;
                                                
                                                segment.railway.via_stops.forEach(stop => {
                                                    if (stop && stop.name) {
                                                        detail += `<li><i class="fas fa-circle"></i> ${stop.name}</li>`;
                                                    }
                                                });
                                                
                                                detail += `<li><i class="fas fa-arrow-alt-circle-down"></i> <strong>${arrivalStop}</strong> (下车)</li>`;
                                                detail += '</ul>';
                                            }
                                        }
                                        
                                        instruction = `乘坐 <span class="route-line-name">${segment.railway.name}</span>，从 <strong>${departureStop}</strong> 上车，到 <strong>${arrivalStop}</strong> 下车，共 ${viaStopsCount} 站`;
                                    } else if (segment.walking) {
                                        instruction = `步行 ${(segment.walking.distance/1000).toFixed(1)} 公里`;
                                        
                                        // 如果有具体步行指南，显示指南
                                        if (segment.instruction) {
                                            detail = `<p class="walking-instruction">${segment.instruction}</p>`;
                                        }
                                    } else {
                                        instruction = '未知路段';
                                    }
                                }
                                
                                // 添加风格类以区分不同类型的路段
                                stepElement.classList.add(`segment-${segmentType}`);
                                
                                // 构建更丰富的HTML内容
                                stepElement.innerHTML = `
                                    <div class="segment-header">
                                        <i class="${icon} segment-icon"></i> 
                                        <div class="segment-main">
                                            <strong class="segment-type">${segmentType}</strong>
                                            <div class="segment-instruction">${instruction}</div>
                                            <div class="segment-time"><i class="far fa-clock"></i> ${formatDuration(segment.time)}, <i class="fas fa-route"></i> ${(segment.distance/1000).toFixed(1)}公里</div>
                                        </div>
                                    </div>
                                    ${detail ? `<div class="segment-detail">${detail}</div>` : ''}
                                `;
                                
                                routeDetail.appendChild(stepElement);
                            });
                        }
                        break;
                        
                    case '步行':
                    case '驾车':
                    case '骑行':
                        if (result.routes && result.routes.length > 0) {
                            route = result.routes[0];
                            steps = route.steps;
                            
                            // 添加总体概述
                            routeDetail.innerHTML = `
                                <div class="route-summary">
                                    <p><i class="fas fa-clock icon"></i> 总时间: ${formatDuration(route.time)}</p>
                                    <p><i class="fas fa-road icon"></i> 总距离: ${(route.distance/1000).toFixed(1)}公里</p>
                                </div>
                            `;
                            
                            // 添加简要步骤（不是所有步骤，太详细会很冗长）
                            const totalSteps = steps.length;
                            const displaySteps = totalSteps > 6 ? 
                                [steps[0], steps[1], steps[2], steps[totalSteps-3], steps[totalSteps-2], steps[totalSteps-1]] : 
                                steps;
                            
                            if (totalSteps > 6) {
                                const stepElement = document.createElement('div');
                                stepElement.className = 'route-step';
                                stepElement.innerHTML = `<p>...中间省略${totalSteps - 6}个步骤...</p>`;
                                
                                // 插入占位元素
                                displaySteps.splice(3, 0, { instruction: '...中间省略...' });
                            }
                            
                            displaySteps.forEach((step, index) => {
                                if (step.instruction === '...中间省略...') {
                                    const stepElement = document.createElement('div');
                                    stepElement.className = 'route-step';
                                    stepElement.innerHTML = `<p>...中间省略${totalSteps - 6}个步骤...</p>`;
                                    routeDetail.appendChild(stepElement);
                                    return;
                                }
                                
                                const stepElement = document.createElement('div');
                                stepElement.className = 'route-step';
                                stepElement.innerHTML = `
                                    <p>${step.instruction}</p>
                                    <p><small>${(step.distance/1000).toFixed(1)}公里</small></p>
                                `;
                                routeDetail.appendChild(stepElement);
                            });
                        }
                        break;
                }
            } else {
                routeDetail.innerHTML = `
                    <p>无法规划路线，请尝试其他交通方式或地址。</p>
                    <p>错误信息: ${result.info}</p>
                `;
            }
            
            // 将路线详情添加到路线卡片
            routeCard.appendChild(routeDetail);
            
            // 添加在地图上显示路线的按钮
            const showOnMapBtn = document.createElement('button');
            showOnMapBtn.className = 'btn-accent';
            showOnMapBtn.style.marginTop = '10px';
            showOnMapBtn.innerHTML = '<i class="fas fa-map-marked-alt"></i> 在地图上显示';
            
            showOnMapBtn.addEventListener('click', function() {
                // 这里可以实现在地图上绘制路线的功能
                alert('路线已在地图上显示（此功能仅作演示）');
            });
            
            routeCard.appendChild(showOnMapBtn);
        }
        
        // 获取公交路段说明
        function getSegmentInstruction(segment) {
            if (segment.walking && segment.walking.distance > 0) {
                return `步行${(segment.walking.distance/1000).toFixed(1)}公里`;
            } else if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
                const busline = segment.bus.buslines[0];
                let viaStopsCount = 0;
                if (busline.via_stops && Array.isArray(busline.via_stops)) {
                    viaStopsCount = busline.via_stops.length;
                }
                
                let busName = busline.name || '未知路线';
                let departureStop = (busline.departure_stop && busline.departure_stop.name) ? busline.departure_stop.name : '起点';
                let arrivalStop = (busline.arrival_stop && busline.arrival_stop.name) ? busline.arrival_stop.name : '终点';
                
                return `乘坐${busName}，从${departureStop}上车，到${arrivalStop}下车，共${viaStopsCount}站`;
            } else if (segment.railway && segment.railway.name) {
                let viaStopsCount = 0;
                if (segment.railway.via_stops && Array.isArray(segment.railway.via_stops)) {
                    viaStopsCount = segment.railway.via_stops.length;
                }
                
                let railwayName = segment.railway.name || '未知地铁线';
                let departureStop = (segment.railway.departure_stop && segment.railway.departure_stop.name) ? segment.railway.departure_stop.name : '起点';
                let arrivalStop = (segment.railway.arrival_stop && segment.railway.arrival_stop.name) ? segment.railway.arrival_stop.name : '终点';
                
                return `乘坐${railwayName}，从${departureStop}上车，到${arrivalStop}下车，共${viaStopsCount}站`;
            } else {
                return '未知路段';
            }
        }
        
        // 格式化时间（秒转为分钟和小时）
        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}秒`;
            } else if (seconds < 3600) {
                return `${Math.floor(seconds / 60)}分钟`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}小时${minutes}分钟`;
            }
        }
        
        // 地理编码（地址转经纬度）
        function geocodeAddress(address, callback) {
            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder({
                    city: '北京'
                });
                
                geocoder.getLocation(address, function(status, result) {
                    if (status === 'complete' && result.info === 'OK') {
                        if (result.geocodes.length > 0) {
                            const location = result.geocodes[0].location;
                            callback(`${location.lng},${location.lat}`);
                        } else {
                            callback(null);
                        }
                    } else {
                        callback(null);
                    }
                });
            });
        }
        
        // 激活标签
        function activateTab(tabId) {
            try {
                // 更新标签按钮状态
                const tabBtns = document.querySelectorAll('.tab-btn');
                tabBtns.forEach(btn => {
                    if (btn.getAttribute('data-tab') === tabId) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // 更新标签面板状态
                const tabPanels = document.querySelectorAll('.tab-panel');
                tabPanels.forEach(panel => {
                    if (panel.id === `${tabId}-tab`) {
                        panel.classList.add('active');
                    } else {
                        panel.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error('激活标签时出错:', error);
            }
        }
        
        // 获取天气信息
        function getWeatherData(city) {
            if (!city) {
                city = '北京'; // 默认城市
            }
            
            // 显示加载中状态
            const currentWeatherEl = document.querySelector('.current-weather');
            currentWeatherEl.innerHTML = `
                <div class="weather-loading">
                    <div class="loader"></div>
                    <p>正在获取${city}天气信息...</p>
                </div>
            `;
            
            // 清空预报区域
            const forecastEl = document.querySelector('.weather-forecast');
            forecastEl.innerHTML = '';
            
            // 使用高德地图天气API获取数据
            AMap.plugin('AMap.Weather', function() {
                const weather = new AMap.Weather();
                
                // 获取实时天气
                weather.getLive(city, function(err, data) {
                    if (err) {
                        renderWeatherError(currentWeatherEl, '获取实时天气失败');
                        console.error('获取实时天气失败', err);
                        return;
                    }
                    
                    renderCurrentWeather(currentWeatherEl, data);
                });
                
                // 获取天气预报
                weather.getForecast(city, function(err, data) {
                    if (err) {
                        forecastEl.innerHTML = '<p class="error-message">获取天气预报失败</p>';
                        console.error('获取天气预报失败', err);
                        return;
                    }
                    
                    renderWeatherForecast(forecastEl, data.forecasts);
                });
            });
        }
        
        // 渲染当前天气
        function renderCurrentWeather(container, data) {
            // 为天气类型选择适当的图标
            let weatherIcon = 'fa-cloud-sun';
            if (data.weather.includes('晴')) {
                weatherIcon = 'fa-sun';
            } else if (data.weather.includes('多云')) {
                weatherIcon = 'fa-cloud-sun';
            } else if (data.weather.includes('阴')) {
                weatherIcon = 'fa-cloud';
            } else if (data.weather.includes('雨')) {
                if (data.weather.includes('雷')) {
                    weatherIcon = 'fa-bolt';
                } else {
                    weatherIcon = 'fa-cloud-rain';
                }
            } else if (data.weather.includes('雪')) {
                weatherIcon = 'fa-snowflake';
            } else if (data.weather.includes('雾') || data.weather.includes('霾')) {
                weatherIcon = 'fa-smog';
            }
            
            container.innerHTML = `
                <div class="weather-icon">
                    <i class="fas ${weatherIcon}"></i>
                </div>
                <div class="weather-info">
                    <div class="temperature">${data.temperature}°C</div>
                    <div class="weather-desc">${data.weather}</div>
                    <div class="weather-details">
                        <div class="weather-detail-item">
                            <i class="fas fa-wind"></i>
                            <span>${data.windDirection} ${data.windPower}级</span>
                        </div>
                        <div class="weather-detail-item">
                            <i class="fas fa-tint"></i>
                            <span>湿度 ${data.humidity}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加动画效果
            container.classList.add('animated', 'fadeInUp');
        }
        
        // 渲染天气预报
        function renderWeatherForecast(container, forecasts) {
            if (!forecasts || forecasts.length === 0) {
                container.innerHTML = '<p class="error-message">暂无天气预报数据</p>';
                return;
            }
            
            // 清空容器
            container.innerHTML = '';
            
            // 最多显示4天预报
            const maxDays = Math.min(forecasts.length, 4);
            
            for (let i = 0; i < maxDays; i++) {
                const forecast = forecasts[i];
                
                // 为天气类型选择适当的图标
                let weatherIcon = 'fa-cloud-sun';
                if (forecast.dayweather.includes('晴')) {
                    weatherIcon = 'fa-sun';
                } else if (forecast.dayweather.includes('多云')) {
                    weatherIcon = 'fa-cloud-sun';
                } else if (forecast.dayweather.includes('阴')) {
                    weatherIcon = 'fa-cloud';
                } else if (forecast.dayweather.includes('雨')) {
                    if (forecast.dayweather.includes('雷')) {
                        weatherIcon = 'fa-bolt';
                    } else {
                        weatherIcon = 'fa-cloud-rain';
                    }
                } else if (forecast.dayweather.includes('雪')) {
                    weatherIcon = 'fa-snowflake';
                } else if (forecast.dayweather.includes('雾') || forecast.dayweather.includes('霾')) {
                    weatherIcon = 'fa-smog';
                }
                
                // 将日期转换为更友好的格式
                const date = new Date(forecast.date);
                const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                const weekday = weekdays[date.getDay()];
                
                // 获取月日
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dateStr = i === 0 ? '今天' : `${month}/${day} ${weekday}`;
                
                const forecastItem = document.createElement('div');
                forecastItem.className = 'forecast-item animated fadeInUp';
                forecastItem.style.animationDelay = `${i * 0.1}s`;
                
                forecastItem.innerHTML = `
                    <div class="forecast-date">${dateStr}</div>
                    <div class="forecast-icon">
                        <i class="fas ${weatherIcon}"></i>
                    </div>
                    <div class="forecast-temp">${forecast.daytemp}°/${forecast.nighttemp}°</div>
                    <div class="forecast-desc">${forecast.dayweather}</div>
                `;
                
                container.appendChild(forecastItem);
            }
        }
        
        // 渲染天气错误信息
        function renderWeatherError(container, message) {
            container.innerHTML = `
                <div class="weather-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // 初始化天气功能
        function initWeather() {
            try {
                // 获取默认城市天气
                getWeatherData('北京');
                
                // 监听城市选择变化
                const citySelect = document.getElementById('weather-city-select');
                if (citySelect) {
                    citySelect.addEventListener('change', function() {
                        getWeatherData(this.value);
                    });
                }
            } catch (error) {
                console.error('初始化天气功能时出错:', error);
            }
        }
    </script>
</body>
</html>
